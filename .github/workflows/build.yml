name: Ultra-Fast Low-Space Universal Vendor 14-16 / Evolution X / GSI

on:
  workflow_dispatch:
    inputs:
      TARGET_SDK:
        description: 'Target SDK for GSI (14/15/16)'
        default: '15'
        required: true

env:
  TZ: Africa/Cairo
  USE_CCACHE: 1
  CCACHE_EXEC: /usr/bin/ccache
  CCACHE_DIR: ~/.ccache
  CCACHE_MAXSIZE: 5G
  BUILD_DIR: $HOME/build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Disk Space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          swap-size-mb: 8192
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev lib32z1-dev \
            libncurses6 python-is-python3

          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod +x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Cleanup Disk Space
        run: |
          sudo rm -rf ~/.cache/*
          df -h

      - name: Create Build Directory
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          pwd

      - name: Clone Minimal Device / Vendor / Kernel (Token)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd $BUILD_DIR
          # Device tree
          git clone https://$GITHUB_TOKEN@github.com/LineageOS/android_device_samsung_gta4l \
            -b lineage-22.1 device/samsung/gta4l --depth=1
          # Vendor blobs
          git clone https://$GITHUB_TOKEN@github.com/TheMuppets/proprietary_vendor_samsung_gta4l \
            -b lineage-22.1 vendor/samsung/gta4l --depth=1
          # Kernel
          git clone https://$GITHUB_TOKEN@github.com/LineageOS/android_kernel_samsung_gta4l \
            -b lineage-22.1 kernel/samsung/gta4l --depth=1

      - name: Apply Universal Vendor Enhancements
        run: |
          cd $BUILD_DIR
          SDK=${{ github.event.inputs.TARGET_SDK }}

          # RAM / ZRAM / LMKD / low_ram
          cat <<EOF >> vendor/build.prop
          ro.zram.enabled=true
          ro.zram.size=1536
          ro.zram.mark_idle_delay_mins=20
          ro.lmk.use_psi=true
          ro.lmk.kill_heaviest_task=false
          ro.lmk.psi_complete_stall_ms=120
          ro.lmk.psi_partial_stall_ms=70
          ro.lmk.thrashing_limit=25
          ro.lmk.thrashing_limit_decay=8
          ro.config.low_ram=true
          ro.sys.fw.bg_apps_limit=20
          EOF

          # Treble + VNDK + dynamic SDK
          cat <<EOF >> vendor/build.prop
          ro.treble.enabled=true
          ro.vendor.vndk.version=$SDK
          ro.vndk.version=$SDK
          ro.product.vndk.version=$SDK
          ro.vendor.sdk.version=$SDK
          ro.board.first_api_level=$((SDK-5))
          EOF

          # Remove branding
          sed -i '/lineage\./d;/evolution\./d' vendor/build.prop || true

          # FSTAB safe for any GSI
          mkdir -p vendor/etc || true
          touch vendor/etc/fstab.qcom
          sed -i 's|/dev/block/.*system|system|g' vendor/etc/fstab.qcom || true
          sed -i 's|/dev/block/.*vendor|vendor|g' vendor/etc/fstab.qcom || true
          sed -i 's|/dev/block/.*product|product|g' vendor/etc/fstab.qcom || true

      - name: Build Vendor Image
        run: |
          cd $BUILD_DIR
          export TARGET_PRODUCT=aosp_gta4l
          export TARGET_BUILD_VARIANT=userdebug
          export TARGET_BOARD_PLATFORM=ap3a
          source build/envsetup.sh || true
          lunch aosp_gta4l-ap3a-userdebug || true
          mka vendorimage -j$(nproc --all) || true

      - name: Upload Vendor Image
        uses: actions/upload-artifact@v4
        with:
          name: UltraFast-LowSpace-Vendor-gta4l-SDK${{ github.event.inputs.TARGET_SDK }}
          path: $BUILD_DIR/out/target/product/gta4l/vendor.img
