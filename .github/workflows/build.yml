name: Universal Vendor SDK35 PRO (AOSP / GSI / EvolutionX)

on:
  workflow_dispatch:

env:
  TZ: Africa/Cairo
  USE_CCACHE: 1
  CCACHE_EXEC: /usr/bin/ccache
  CCACHE_DIR: ~/.ccache
  CCACHE_MAXSIZE: 10G

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Disk Space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 1024
          swap-size-mb: 4096
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf \
            libxml2 libxml2-utils lzop pngcrush rsync \
            schedtool squashfs-tools xsltproc zip \
            zlib1g-dev lib32z1-dev libncurses6 \
            python-is-python3

          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod +x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Sync AOSP Android 15 (SDK 35)
        run: |
          mkdir -p build && cd build

          repo init \
            -u https://android.googlesource.com/platform/manifest \
            -b android-15.0.0_r5 \
            --depth=1

          repo sync -c -j$(nproc --all) \
            --force-sync \
            --no-tags \
            --no-clone-bundle

          # Device / Vendor / Kernel (public)
          git clone https://github.com/LineageOS/android_device_samsung_gta4l \
            -b lineage-22.1 device/samsung/gta4l --depth=1

          git clone https://github.com/TheMuppets/proprietary_vendor_samsung_gta4l \
            -b lineage-22.1 vendor/samsung/gta4l --depth=1

          git clone https://github.com/LineageOS/android_kernel_samsung_gta4l \
            -b lineage-22.1 kernel/samsung/gta4l --depth=1

      - name: Vendor Treble + SDK 35 Hardening
        run: |
          cd build

          cat <<EOF >> vendor/build.prop
          # ===== TREBLE / SDK 35 =====
          ro.treble.enabled=true
          ro.vendor.vndk.version=35
          ro.vndk.version=35
          ro.product.vndk.version=35
          ro.vendor.sdk.version=35
          ro.board.first_api_level=30
          EOF

          # Remove ROM branding
          sed -i '/lineage\./d;/evolution\./d;/infinity\./d' vendor/build.prop || true

      - name: RAM Optimization (3GB Devices)
        run: |
          cd build

          cat <<EOF >> vendor/build.prop
          # ===== ZRAM =====
          ro.zram.enabled=true
          ro.zram.size=1536
          ro.zram.mark_idle_delay_mins=20

          # ===== LMKD PSI =====
          ro.lmk.use_psi=true
          ro.lmk.kill_heaviest_task=false
          ro.lmk.psi_complete_stall_ms=120
          ro.lmk.psi_partial_stall_ms=70
          ro.lmk.thrashing_limit=25
          ro.lmk.thrashing_limit_decay=8

          # ===== LOW RAM =====
          ro.config.low_ram=true
          ro.sys.fw.bg_apps_limit=20
          EOF

      - name: FSTAB Sanitization (GSI Safe)
        run: |
          cd build
          sed -i 's|/dev/block/.*system|system|g' vendor/etc/fstab.qcom || true
          sed -i 's|/dev/block/.*vendor|vendor|g' vendor/etc/fstab.qcom || true
          sed -i 's|/dev/block/.*product|product|g' vendor/etc/fstab.qcom || true

      - name: Build Vendor Image
        run: |
          cd build
          source build/envsetup.sh
          lunch aosp_gta4l-ap3a-userdebug
          mka vendorimage -j$(nproc --all)

      - name: Upload Vendor Image
        uses: actions/upload-artifact@v4
        with:
          name: Universal-Vendor-gta4l-AOSP-SDK35-PRO
          path: build/out/target/product/gta4l/vendor.img
