name: Ultra-Fast Low-Space Universal Vendor Dynamic SDK (Fixed build.prop)

on:
  workflow_dispatch:

env:
  TZ: Africa/Cairo
  USE_CCACHE: 1
  CCACHE_EXEC: /usr/bin/ccache
  CCACHE_DIR: ~/.ccache
  CCACHE_MAXSIZE: 5G
  BUILD_DIR: $HOME/build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize Disk Space
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          swap-size-mb: 8192
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev lib32z1-dev \
            libncurses6 python-is-python3

          mkdir -p ~/bin
          curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod +x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Cleanup Disk Space
        run: |
          sudo rm -rf ~/.cache/*
          df -h

      - name: Create Build Directory
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          pwd

      # ===== Checkout Device Tree =====
      - name: Checkout Device Tree
        uses: actions/checkout@v4
        with:
          repository: LineageOS/android_device_samsung_gta4l
          ref: lineage-22.1
          path: device/samsung/gta4l
          token: ${{ secrets.GITHUB_TOKEN }}

      # ===== Checkout Vendor Blobs =====
      - name: Checkout Vendor Blobs
        uses: actions/checkout@v4
        with:
          repository: TheMuppets/proprietary_vendor_samsung_gta4l
          ref: lineage-22.1
          path: vendor/samsung/gta4l
          token: ${{ secrets.GITHUB_TOKEN }}

      # ===== Apply Universal Vendor Enhancements =====
      - name: Apply Universal Vendor Enhancements
        run: |
          cd $BUILD_DIR
          VENDOR_PATH=vendor/samsung/gta4l

          # تأكد إن build.prop موجود أو اعمل واحد جديد
          if [ -f $VENDOR_PATH/build.prop ]; then
              BUILD_PROP=$VENDOR_PATH/build.prop
          else
              mkdir -p $VENDOR_PATH
              BUILD_PROP=$VENDOR_PATH/build.prop
              touch $BUILD_PROP
          fi

          # RAM / ZRAM / LMKD / low_ram للأجهزة 3GB
          cat <<EOF >> $BUILD_PROP
ro.zram.enabled=true
ro.zram.size=1536
ro.zram.mark_idle_delay_mins=20
ro.lmk.use_psi=true
ro.lmk.kill_heaviest_task=false
ro.lmk.psi_complete_stall_ms=120
ro.lmk.psi_partial_stall_ms=70
ro.lmk.thrashing_limit=25
ro.lmk.thrashing_limit_decay=8
ro.config.low_ram=true
ro.sys.fw.bg_apps_limit=20
EOF

          # Treble + VNDK + Dynamic SDK
          cat <<EOF >> $BUILD_PROP
ro.treble.enabled=true
ro.vendor.vndk.version=${ro.vendor.vndk.version}
ro.vndk.version=${ro.vndk.version}
ro.product.vndk.version=${ro.product.vndk.version}
ro.vendor.sdk.version=${ro.vendor.sdk.version}
ro.board.first_api_level=${ro.board.first_api_level}
EOF

          # إزالة أي branding من lineage/evolution
          sed -i '/lineage\./d;/evolution\./d' $BUILD_PROP || true

          # FSTAB safe لأي GSI
          mkdir -p $VENDOR_PATH/etc || true
          FSTAB_FILE=$VENDOR_PATH/etc/fstab.qcom
          touch $FSTAB_FILE
          sed -i 's|/dev/block/.*system|system|g' $FSTAB_FILE || true
          sed -i 's|/dev/block/.*vendor|vendor|g' $FSTAB_FILE || true
          sed -i 's|/dev/block/.*product|product|g' $FSTAB_FILE || true

      # ===== Build Vendor Image =====
      - name: Build Vendor Image
        run: |
          cd $BUILD_DIR
          export TARGET_PRODUCT=aosp_gta4l
          export TARGET_BUILD_VARIANT=userdebug
          export TARGET_BOARD_PLATFORM=ap3a
          source build/envsetup.sh || true
          lunch aosp_gta4l-ap3a-userdebug || true
          mka vendorimage -j$(nproc --all) || true

      # ===== Upload Vendor Image =====
      - name: Upload Vendor Image
        uses: actions/upload-artifact@v4
        with:
          name: UltraFast-LowSpace-Universal-Vendor-gta4l-DynamicSDK
          path: $BUILD_DIR/out/target/product/gta4l/vendor.img
